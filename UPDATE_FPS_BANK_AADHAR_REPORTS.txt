
ALTER PROCEDURE [dbo].[UPDATE_FPS_BANK_AADHAR_REPORTS]
    (
        @VCH_ACTION        VARCHAR(2) =  NULL,
        @KMS			   VARCHAR(10) = NULL,
		@DISTID			   VARCHAR(2) =  NULL,
		@VCH_BLOCKID       VARCHAR(10) = NULL, -- ADDED ON 2024-02-16 12:11:21.420 BY RAHUL KUMAR [01-3101] FOR (ACTION C)
		@P_INTSTATUS       INT = NULL
       
       
    )
AS

    BEGIN
        IF (@VCH_ACTION = 'A')
            BEGIN

                SELECT 
				int_DistrictID,
				vch_DistrictName[DISTNAME],
				(SELECT COUNT(1) FROM M_PDS_FPS_LICENSEAPPLY WHERE INTDELETEDFLAG=0 AND INTYEAR=2023 AND SUBSTRING(VCHOLDLICENSENO,1,2)=int_DistrictID and VCHLICENSENO is not null)[NO OF  FPS],
				(SELECT COUNT(1) FROM M_PDS_FPS_LICENSEAPPLY WHERE INTDELETEDFLAG=0 AND ISNULL(IntBankdetailsUpdatedstatus,0)=1 AND INTYEAR=2023 AND  VCHLICENSENO is not null AND SUBSTRING	(VCHOLDLICENSENO,1,2)=int_DistrictID)[NO OF APPROVE FPS],
				(SELECT COUNT(1) FROM M_PDS_FPS_LICENSEAPPLY WHERE INTDELETEDFLAG=0 AND ISNULL(IntBankdetailsUpdatedstatus,0)=0 AND INTYEAR=2023 AND  VCHLICENSENO is not null AND SUBSTRING(VCHOLDLICENSENO,1,2)=int_DistrictID)[NO OF PENDING FPS]
				FROM PDS_DistrictMaster

            END

        IF (@VCH_ACTION = 'B')
            BEGIN
    --           SELECT distinct
				--D.vch_DistrictName [DISTRICT_NAME],
				--B.vch_BlockName [BLOCK_NAME],
				--M.VCHOLDLICENSENO[FPSCODE],
				--T.VCHAPPLICANTNAME[NAME],
				--M.VCHLICENSENO[VCHLICENSENO],
				--M.VCHAPPLICANTMOBILE[VCHAPPLICANTMOBILE],
				--ISNULL(CONVERT(VARCHAR,dtmBankdetailsUpdated,106),'--NA--')[BANKVALIDATEDATE]
				--FROM M_PDS_FPS_LICENSEAPPLY M
				--INNER JOIN T_PDS_FPS_LICENSEEDETAILS T
				--ON M.INTFPSID=T.INTLICID
				--JOIN PDS_DistrictMaster D
				--ON T.VCHDISTID = D.int_DistrictID
				--JOIN PDS_BlockMaster B
				--ON t.VCHBLOCKID = B.int_BlockID
				--WHERE
				-- M.INTDELETEDFLAG=0
				-- AND T.INTDELETEDFLAG=0
				--AND ISNULL(IntBankdetailsUpdatedstatus,0)=1
				--AND INTYEAR=@KMS-1
				--and isnull(intbankdetailsvalidateayear,0)=@KMS
				--and VCHLICENSENO is not null 
				--AND T.VCHDISTID=@DISTID
				----AND B.int_BlockID = @VCH_BLOCKID
				--AND  VCHLICENSENO is not null
				----ORDER BY T.VCHDISTID
				IF(@P_INTSTATUS = 1) 
				BEGIN
				SELECT vch_DistrictName [DISTRICT_NAME],
					vch_BlockName [BLOCK_NAME],
					VCHOLDLICENSENO[FPSCODE],
					T.VCHAPPLICANTNAME[NAME],
					M.VCHLICENSENO[VCHLICENSENO],
					M.VCHAPPLICANTMOBILE[VCHAPPLICANTMOBILE],
					ISNULL(CONVERT(VARCHAR,dtmBankdetailsUpdated,106),'--NA--')[BANKVALIDATEDATE]
					FROM M_PDS_FPS_LICENSEAPPLY M
					INNER JOIN T_PDS_FPS_LICENSEEDETAILS T
					ON M.INTFPSID=T.INTLICID
					JOIN PDS_DistrictMaster D
					ON T.VCHDISTID = D.int_DistrictID
					JOIN PDS_BlockMaster B
					ON t.VCHBLOCKID = B.int_BlockID 
					WHERE
					M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
					and VCHLICENSENO is not null
					AND M.INTAPPROVESTATUS=4
					AND M.INTYEAR=@KMS-1
					AND T.VCHDISTID=@DISTID
					ORDER BY vch_DistrictName,vch_BlockName
				END
				ELSE
				BEGIN
				SELECT vch_DistrictName [DISTRICT_NAME],
					vch_BlockName [BLOCK_NAME],
					VCHOLDLICENSENO[FPSCODE],
					T.VCHAPPLICANTNAME[NAME],
					M.VCHLICENSENO[VCHLICENSENO],
					M.VCHAPPLICANTMOBILE[VCHAPPLICANTMOBILE],
					ISNULL(CONVERT(VARCHAR,dtmBankdetailsUpdated,106),'--NA--')[BANKVALIDATEDATE]
					FROM M_PDS_FPS_LICENSEAPPLY M
					INNER JOIN T_PDS_FPS_LICENSEEDETAILS T
					ON M.INTFPSID=T.INTLICID
					JOIN PDS_DistrictMaster D
					ON T.VCHDISTID = D.int_DistrictID
					JOIN PDS_BlockMaster B
					ON t.VCHBLOCKID = B.int_BlockID 
					WHERE
					M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
					and VCHLICENSENO is not null
					AND M.INTAPPROVESTATUS=4
					AND M.INTYEAR=@KMS-1
					AND T.VCHDISTID=@DISTID
					AND INTACTTYPE=5
				    AND SUBSTRING(VCHREFERENCENO,3,1)='W'
					ORDER BY vch_DistrictName,vch_BlockName
				END
				END
       
	     IF (@VCH_ACTION= 'C')  -- ADDED ON 2024-02-16 12:11:21.420 BY RAHUL KUMAR [01-3101]
		  
		  BEGIN

				SELECT 
				[DISTRICT_NAME],
				[DISTRICT_CODE],
				[BLOCK_CODE],
				[BLOCK_NAME],
				[NO_OF_FPS],
				[NO_OF_APPROVE_FPS],
				[NO_OF_PENDING_FPS],
				[NO_OF_FPS_APPLIED_FOR_RENEWAL],
				([NO_OF_FPS] - [NO_OF_FPS_APPLIED_FOR_RENEWAL]) AS [NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL],
				CASE WHEN [NO_OF_FPS] = 0 THEN 0 ELSE
				ROUND((CAST([NO_OF_APPROVE_FPS]AS DECIMAL)/CAST([NO_OF_FPS]AS DECIMAL))*100,3) END AS[PRCNT_OF_UPDATED_FPS],
				CASE WHEN [NO_OF_FPS] = 0 THEN 0 ELSE
				ROUND((CAST([NO_OF_FPS_APPLIED_FOR_RENEWAL]AS DECIMAL)/CAST([NO_OF_FPS]AS DECIMAL))*100,3)END AS[PRCNT_OF_RENEWAL_APPLICATION]
				FROM(
				SELECT 
				DISTINCT D.vch_DistrictName [DISTRICT_NAME],
				D.int_DistrictID [DISTRICT_CODE],
				B.vch_BlockName [BLOCK_NAME],
				B.int_BlockID [BLOCK_CODE],
				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				WHERE INTDELETEDFLAG=0
				AND INTYEAR=@KMS
				AND SUBSTRING(VCHOLDLICENSENO,1,2) = D.int_DistrictID
				AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
				and VCHLICENSENO is not null)[NO_OF_FPS],
				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				WHERE INTDELETEDFLAG=0 AND ISNULL(IntBankdetailsUpdatedstatus,0)=1 
				AND INTYEAR=@KMS 
				and isnull(intbankdetailsvalidateayear,0)=@KMS+1
				AND VCHLICENSENO is not null 
				AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
				AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
				)[NO_OF_APPROVE_FPS],
				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				WHERE INTDELETEDFLAG=0 AND ISNULL(IntBankdetailsUpdatedstatus,0)=0 
				AND INTYEAR = @KMS
				AND VCHLICENSENO is not null 
				AND SUBSTRING(VCHOLDLICENSENO,1,2)= D.int_DistrictID
				AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
				)[NO_OF_PENDING_FPS],
				(
				SELECT COUNT(1) FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				WHERE VCHOLDLICENSENO IN (
				SELECT VCHOLDLICENSENO 
				FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				WHERE VCHOLDLICENSENO != ''  AND INTYEAR IN (2023,2024) AND INTLEVEL = 2 AND INTAPPROVESTATUS = 4
				AND INTDELETEDFLAG = 0
				AND VCHLICENSENO is not null 
				AND SUBSTRING(VCHOLDLICENSENO,1,2)= D.int_DistrictID
				AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
				GROUP BY VCHOLDLICENSENO
				HAVING COUNT(VCHOLDLICENSENO) !=1
				)
				AND  INTYEAR = 2024
				) [NO_OF_FPS_APPLIED_FOR_RENEWAL]
				--(
				--SELECT COUNT(1)
				--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				--WHERE VCHOLDLICENSENO != ''  AND INTYEAR = 2023 AND INTLEVEL = 2 AND INTAPPROVESTATUS = 4
				--AND INTDELETEDFLAG = 0
				--AND INTYEAR != 2024
				--AND VCHLICENSENO is not null 
				--AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
				--AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
				--) 
				--[NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL]

				FROM PDS_DistrictMaster D WITH (NOLOCK)
				JOIN PDS_BlockMaster B WITH (NOLOCK)
				ON D.int_DistrictID = B.int_DistrictID
				where D.int_DistrictID = @DISTID
				AND B.int_BlockID = CASE WHEN @VCH_BLOCKID <> '' THEN @VCH_BLOCKID ELSE B.int_BlockID END
				)R

		  END
		 IF (@VCH_ACTION= 'D')  -- ADDED ON 2024-02-16 12:11:21.420 BY RAHUL KUMAR [01-3101]
		  BEGIN


		  IF(@P_INTSTATUS = 1) 

		  BEGIN
		  
		  	SELECT 
				[VCHDISTID],@KMS[INTYEAR],
				[DISTRICT_NAME],
				[NO_OF_FPS],
				[NO_OF_APPROVE_FPS],
				([NO_OF_FPS]-[NO_OF_APPROVE_FPS]) AS [NO_OF_PENDING_FPS],
				[NO_OF_FPS_APPLIED_FOR_RENEWAL],
				CASE WHEN LEFT(([NO_OF_FPS] - [NO_OF_FPS_APPLIED_FOR_RENEWAL]),1) = '-' THEN 0
				ELSE ([NO_OF_FPS] - [NO_OF_FPS_APPLIED_FOR_RENEWAL]) END AS [NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL],
				[NO_OF_FPS_FOR_APPROVAL],
				CASE WHEN [NO_OF_FPS] = 0 THEN 0 ELSE
				ROUND((CAST([NO_OF_APPROVE_FPS]AS DECIMAL)/CAST([NO_OF_FPS]AS DECIMAL))*100,3) END AS[PRCNT_OF_UPDATED_FPS],
				CASE WHEN [NO_OF_FPS] = 0 THEN 0 ELSE
				ROUND((CAST([NO_OF_FPS_APPLIED_FOR_RENEWAL]AS DECIMAL)/CAST([NO_OF_FPS]AS DECIMAL))*100,3)END AS[PRCNT_OF_RENEWAL_APPLICATION]
				FROM(
				SELECT
				DISTINCT
				D.int_DistrictID[VCHDISTID], 
				 D.vch_DistrictName [DISTRICT_NAME],
				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
				inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
				on M.INTFPSID = T.INTLICID
				WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
				AND M.INTYEAR=@KMS-1
				AND M.INTAPPROVESTATUS=4
				AND SUBSTRING(VCHOLDLICENSENO,1,2) = D.int_DistrictID
				and VCHLICENSENO is not null)[NO_OF_FPS],
				(
					SELECT COUNT(1)  
					FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK) 
					WHERE VCHOLDLICENSENO in(
					select distinct VCHOLDLICENSENO from M_PDS_FPS_LICENSEAPPLY where INTYEAR=@KMS-1 and IntBankdetailsUpdatedstatus=1 and 
					intbankdetailsvalidateayear=@KMS and INTDELETEDFLAG=0 
					AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
					) and INTYEAR=@KMS and INTDELETEDFLAG=0 
					AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
				)[NO_OF_APPROVE_FPS],
				--(
				--SELECT COUNT(1) 
				--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				--WHERE INTDELETEDFLAG=0 
				--AND ISNULL(IntBankdetailsUpdatedstatus,0)=0 
				--AND INTYEAR=@KMS - 1 
				--AND VCHLICENSENO is not null 
				--AND SUBSTRING(VCHOLDLICENSENO,1,2)= D.int_DistrictID
				
				--)[NO_OF_PENDING_FPS],
				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
				inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
				on M.INTFPSID = T.INTLICID
				WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
				AND M.INTYEAR=@KMS
				AND SUBSTRING(VCHOLDLICENSENO,1,2) = D.int_DistrictID
				) [NO_OF_FPS_APPLIED_FOR_RENEWAL],

				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
				inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
				on M.INTFPSID = T.INTLICID
				WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
				AND M.INTYEAR=@KMS
				AND INTLEVEL=2
				AND M.INTAPPROVESTATUS=4
				AND SUBSTRING(VCHOLDLICENSENO,1,2) = D.int_DistrictID
				and VCHLICENSENO is not null)[NO_OF_FPS_FOR_APPROVAL]
				
				--(
				--SELECT COUNT(1)
				--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				--WHERE VCHOLDLICENSENO != ''  AND INTYEAR = @KMS-1 AND INTLEVEL = 2 AND INTAPPROVESTATUS = 4
				--AND INTDELETEDFLAG = 0
				--AND INTYEAR != @KMS
				--AND VCHLICENSENO is not null 
				--AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
				
				--) 
				--[NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL]

				FROM PDS_DistrictMaster D WITH (NOLOCK)
				JOIN PDS_BlockMaster B WITH (NOLOCK)
				ON D.int_DistrictID = B.int_DistrictID
				where D.int_DistrictID = CASE WHEN @DISTID <> '' THEN @DISTID ELSE D.int_DistrictID END
				)R

		  END

		  ELSE 

		  BEGIN
		     SELECT 
				[VCHDISTID],@KMS[INTYEAR],
				[DISTRICT_NAME],
				[NO_OF_WHOLESALER],
				[NO_OF_APPROVE_WHOLESALER],
				CASE WHEN LEFT(([NO_OF_WHOLESALER]-[NO_OF_APPROVE_WHOLESALER]),1) = '-' THEN 0 
				ELSE ([NO_OF_WHOLESALER]-[NO_OF_APPROVE_WHOLESALER]) END AS [NO_OF_PENDING_WHOLESALER],
				[NO_OF_WHOLESALER_APPLIED_FOR_RENEWAL],
				CASE WHEN LEFT(([NO_OF_WHOLESALER] - [NO_OF_WHOLESALER_APPLIED_FOR_RENEWAL]),1) = '-' THEN 0 
				ELSE ([NO_OF_WHOLESALER] - [NO_OF_WHOLESALER_APPLIED_FOR_RENEWAL]) END AS [NO_OF_WHOLESALER_YET_TO_APPLY_FOR_RENEWAL],
				[NO_OF_WHOLESALER_FOR_APPROVAL],
				CASE WHEN [NO_OF_WHOLESALER] = 0 THEN 0 ELSE
				ROUND((CAST([NO_OF_APPROVE_WHOLESALER]AS DECIMAL)/CAST([NO_OF_WHOLESALER]AS DECIMAL))*100,3) END AS[PRCNT_OF_UPDATED_WHOLESALER],
				CASE WHEN [NO_OF_WHOLESALER] = 0 THEN 0 ELSE
				ROUND((CAST([NO_OF_WHOLESALER_APPLIED_FOR_RENEWAL]AS DECIMAL)/CAST([NO_OF_WHOLESALER]AS DECIMAL))*100,3)END AS[PRCNT_OF_RENEWAL_APPLICATION_WHOLESALER]
				FROM(
				SELECT
				DISTINCT
				D.int_DistrictID[VCHDISTID], 
				 D.vch_DistrictName [DISTRICT_NAME],
				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
				inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
				on M.INTFPSID = T.INTLICID
				WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
				AND M.INTYEAR=@KMS-1
				AND M.INTAPPROVESTATUS=4
				AND SUBSTRING(VCHOLDLICENSENO,1,2) = D.int_DistrictID
				AND M.INTACTTYPE=5
				AND SUBSTRING(VCHREFERENCENO,3,1)='W'
				and VCHLICENSENO is not null)[NO_OF_WHOLESALER],
				(
					SELECT COUNT(1)  
					FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK) 
					WHERE VCHOLDLICENSENO in(
					select distinct VCHOLDLICENSENO from M_PDS_FPS_LICENSEAPPLY where INTYEAR=@KMS-1 and IntBankdetailsUpdatedstatus=1 and 
					intbankdetailsvalidateayear=@KMS and INTDELETEDFLAG=0 AND INTACTTYPE=5
				    AND SUBSTRING(VCHREFERENCENO,3,1)='W'
					AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
					) and INTYEAR=@KMS and INTDELETEDFLAG=0 
					AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
					AND INTACTTYPE=5
				AND SUBSTRING(VCHREFERENCENO,3,1)='W'
				)[NO_OF_APPROVE_WHOLESALER],
				--(
				--SELECT COUNT(1) 
				--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				--WHERE INTDELETEDFLAG=0 
				--AND ISNULL(IntBankdetailsUpdatedstatus,0)=0 
				--AND INTYEAR=@KMS - 1 
				--AND VCHLICENSENO is not null 
				--AND SUBSTRING(VCHOLDLICENSENO,1,2)= D.int_DistrictID
				
				--)[NO_OF_PENDING_FPS],
				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
				inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
				on M.INTFPSID = T.INTLICID
				WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
				AND M.INTYEAR=@KMS
				AND SUBSTRING(VCHOLDLICENSENO,1,2) = D.int_DistrictID
				AND INTACTTYPE=5
				AND SUBSTRING(VCHREFERENCENO,3,1)='W'
				) [NO_OF_WHOLESALER_APPLIED_FOR_RENEWAL],
				(
				SELECT COUNT(1) 
				FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
				inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
				on M.INTFPSID = T.INTLICID
				WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
				AND M.INTYEAR=@KMS
				AND INTLEVEL=2
				AND M.INTAPPROVESTATUS=4
				AND SUBSTRING(VCHOLDLICENSENO,1,2) = D.int_DistrictID
				AND INTACTTYPE=5
				AND SUBSTRING(VCHREFERENCENO,3,1)='W'
				and VCHLICENSENO is not null)[NO_OF_WHOLESALER_FOR_APPROVAL]
				
				--(
				--SELECT COUNT(1)
				--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
				--WHERE VCHOLDLICENSENO != ''  AND INTYEAR = @KMS-1 AND INTLEVEL = 2 AND INTAPPROVESTATUS = 4
				--AND INTDELETEDFLAG = 0
				--AND INTYEAR != @KMS
				--AND VCHLICENSENO is not null 
				--AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
				
				--) 
				--[NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL]

				FROM PDS_DistrictMaster D WITH (NOLOCK)
				JOIN PDS_BlockMaster B WITH (NOLOCK)
				ON D.int_DistrictID = B.int_DistrictID
				where D.int_DistrictID = CASE WHEN @DISTID <> '' THEN @DISTID ELSE D.int_DistrictID END
				)R
		  END

		  END


		  		 IF (@VCH_ACTION= 'E')  -- ADDED ON 2024-02-17 09:53:21.420 BY RAHUL KUMAR [01-3101]

				  BEGIN


				  IF(@P_INTSTATUS = 1) 

				  BEGIN
		  
		  			SELECT DISTINCT
						[VCHDISTID],@KMS[INTYEAR],
						[BLOCK_NAME] AS [DISTRICT_NAME],
						[NO_OF_FPS],
						[NO_OF_APPROVE_FPS],
						([NO_OF_FPS]-[NO_OF_APPROVE_FPS]) AS [NO_OF_PENDING_FPS],
						[NO_OF_FPS_APPLIED_FOR_RENEWAL],
						CASE WHEN LEFT(([NO_OF_FPS] - [NO_OF_FPS_APPLIED_FOR_RENEWAL]),1) = '-' THEN 0
						ELSE ([NO_OF_FPS] - [NO_OF_FPS_APPLIED_FOR_RENEWAL]) END AS [NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL],
						[NO_OF_FPS_FOR_APPROVAL],
						CASE WHEN [NO_OF_FPS] = 0 THEN 0 ELSE
						ROUND((CAST([NO_OF_APPROVE_FPS]AS DECIMAL)/CAST([NO_OF_FPS]AS DECIMAL))*100,3) END AS[PRCNT_OF_UPDATED_FPS],
						CASE WHEN [NO_OF_FPS] = 0 THEN 0 ELSE
						ROUND((CAST([NO_OF_FPS_APPLIED_FOR_RENEWAL]AS DECIMAL)/CAST([NO_OF_FPS]AS DECIMAL))*100,3)END AS[PRCNT_OF_RENEWAL_APPLICATION]
						FROM(
						SELECT
						DISTINCT
						D.int_DistrictID[VCHDISTID], 
						D.vch_DistrictName [DISTRICT_NAME],
						B.vch_BlockName [BLOCK_NAME],
						(
						SELECT COUNT(1) 
						FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
						inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
						on M.INTFPSID = T.INTLICID
						WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
						AND M.INTYEAR=@KMS-1
						AND M.INTAPPROVESTATUS=4
						AND SUBSTRING(VCHOLDLICENSENO,1,2) = @DISTID
						AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
						and VCHLICENSENO is not null)[NO_OF_FPS],
						(
							SELECT COUNT(1)  
							FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK) 
							WHERE VCHOLDLICENSENO in(
							select distinct VCHOLDLICENSENO from M_PDS_FPS_LICENSEAPPLY where INTYEAR=@KMS-1 and IntBankdetailsUpdatedstatus=1 and 
							intbankdetailsvalidateayear=@KMS and INTDELETEDFLAG=0 
							AND SUBSTRING (VCHOLDLICENSENO,1,2)= @DISTID
							AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
							) and INTYEAR=@KMS and INTDELETEDFLAG=0 
							AND SUBSTRING (VCHOLDLICENSENO,1,2)= @DISTID
							AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
						)[NO_OF_APPROVE_FPS],
						--(
						--SELECT COUNT(1) 
						--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
						--WHERE INTDELETEDFLAG=0 
						--AND ISNULL(IntBankdetailsUpdatedstatus,0)=0 
						--AND INTYEAR=@KMS - 1 
						--AND VCHLICENSENO is not null 
						--AND SUBSTRING(VCHOLDLICENSENO,1,2)= D.int_DistrictID
				
						--)[NO_OF_PENDING_FPS],
						(
						SELECT COUNT(1) 
						FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
						inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
						on M.INTFPSID = T.INTLICID
						WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
						AND M.INTYEAR=@KMS
						AND SUBSTRING(VCHOLDLICENSENO,1,2) = @DISTID
						AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
						) [NO_OF_FPS_APPLIED_FOR_RENEWAL],

						(
						SELECT COUNT(1) 
						FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
						inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
						on M.INTFPSID = T.INTLICID
						WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
						AND M.INTYEAR=@KMS
						AND INTLEVEL=2
						AND M.INTAPPROVESTATUS=4
						AND SUBSTRING(VCHOLDLICENSENO,1,2) = @DISTID
						AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
						and VCHLICENSENO is not null)[NO_OF_FPS_FOR_APPROVAL]
				
						--(
						--SELECT COUNT(1)
						--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
						--WHERE VCHOLDLICENSENO != ''  AND INTYEAR = @KMS-1 AND INTLEVEL = 2 AND INTAPPROVESTATUS = 4
						--AND INTDELETEDFLAG = 0
						--AND INTYEAR != @KMS
						--AND VCHLICENSENO is not null 
						--AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
				
						--) 
						--[NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL]

						FROM PDS_DistrictMaster D WITH (NOLOCK)
						JOIN PDS_BlockMaster B WITH (NOLOCK)
						ON D.int_DistrictID = B.int_DistrictID
						where D.int_DistrictID = @DISTID
						)R

				  END

				  ELSE 

				  BEGIN
					 SELECT 
						[VCHDISTID],@KMS[INTYEAR],
						
						[BLOCK_NAME] AS [DISTRICT_NAME],
						[NO_OF_FPS],
						[NO_OF_APPROVE_FPS],
						([NO_OF_FPS]-[NO_OF_APPROVE_FPS]) AS [NO_OF_PENDING_FPS],
						[NO_OF_FPS_APPLIED_FOR_RENEWAL],
						CASE WHEN LEFT(([NO_OF_FPS] - [NO_OF_FPS_APPLIED_FOR_RENEWAL]),1) = '-' THEN 0
						ELSE ([NO_OF_FPS] - [NO_OF_FPS_APPLIED_FOR_RENEWAL]) END AS [NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL],
						[NO_OF_FPS_FOR_APPROVAL],
						CASE WHEN [NO_OF_FPS] = 0 THEN 0 ELSE
						ROUND((CAST([NO_OF_APPROVE_FPS]AS DECIMAL)/CAST([NO_OF_FPS]AS DECIMAL))*100,3) END AS[PRCNT_OF_UPDATED_FPS],
						CASE WHEN [NO_OF_FPS] = 0 THEN 0 ELSE
						ROUND((CAST([NO_OF_FPS_APPLIED_FOR_RENEWAL]AS DECIMAL)/CAST([NO_OF_FPS]AS DECIMAL))*100,3)END AS[PRCNT_OF_RENEWAL_APPLICATION]
						FROM(
						SELECT
						DISTINCT
						D.int_DistrictID[VCHDISTID], 
						D.vch_DistrictName [DISTRICT_NAME],
						B.vch_BlockName [BLOCK_NAME],
						(
						SELECT COUNT(1) 
						FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
						inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
						on M.INTFPSID = T.INTLICID
						WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
						AND M.INTYEAR=@KMS-1
						AND M.INTAPPROVESTATUS=4
						AND SUBSTRING(VCHOLDLICENSENO,1,2) = @DISTID
						AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
						AND M.INTACTTYPE=5
						AND SUBSTRING(VCHREFERENCENO,3,1)='W'
						and VCHLICENSENO is not null) [NO_OF_FPS],
						(
							SELECT COUNT(1)  
							FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK) 
							WHERE VCHOLDLICENSENO in(
							select distinct VCHOLDLICENSENO from M_PDS_FPS_LICENSEAPPLY where INTYEAR=@KMS-1 and IntBankdetailsUpdatedstatus=1 and 
							intbankdetailsvalidateayear=@KMS and INTDELETEDFLAG=0 AND INTACTTYPE=5
							AND SUBSTRING(VCHREFERENCENO,3,1)='W'
							AND SUBSTRING (VCHOLDLICENSENO,1,2)= @DISTID
							AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
							) and INTYEAR=@KMS and INTDELETEDFLAG=0 
							AND SUBSTRING (VCHOLDLICENSENO,1,2)= @DISTID
							AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
							AND INTACTTYPE=5
						AND SUBSTRING(VCHREFERENCENO,3,1)='W'
						)[NO_OF_APPROVE_FPS],
						--(
						--SELECT COUNT(1) 
						--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
						--WHERE INTDELETEDFLAG=0 
						--AND ISNULL(IntBankdetailsUpdatedstatus,0)=0 
						--AND INTYEAR=@KMS - 1 
						--AND VCHLICENSENO is not null 
						--AND SUBSTRING(VCHOLDLICENSENO,1,2)= D.int_DistrictID
				
						--)[NO_OF_PENDING_FPS],
						(
						SELECT COUNT(1) 
						FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
						inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
						on M.INTFPSID = T.INTLICID
						WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
						AND M.INTYEAR=@KMS
						AND SUBSTRING(VCHOLDLICENSENO,1,2) = @DISTID
						AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
						AND INTACTTYPE=5
						AND SUBSTRING(VCHREFERENCENO,3,1)='W'
						) [NO_OF_FPS_APPLIED_FOR_RENEWAL],
						(
						SELECT COUNT(1) 
						FROM M_PDS_FPS_LICENSEAPPLY M WITH (NOLOCK)
						inner join T_PDS_FPS_LICENSEEDETAILS T WITH (NOLOCK)
						on M.INTFPSID = T.INTLICID
						WHERE M.INTDELETEDFLAG=0 AND T.INTDELETEDFLAG=0
						AND M.INTYEAR=@KMS
						AND INTLEVEL=2
						AND M.INTAPPROVESTATUS=4
						AND SUBSTRING(VCHOLDLICENSENO,1,2) = @DISTID
						AND SUBSTRING(VCHOLDLICENSENO,1,4) = B.int_BlockID
						AND INTACTTYPE=5
						AND SUBSTRING(VCHREFERENCENO,3,1)='W'
						and VCHLICENSENO is not null)[NO_OF_FPS_FOR_APPROVAL]
				
						--(
						--SELECT COUNT(1)
						--FROM M_PDS_FPS_LICENSEAPPLY WITH (NOLOCK)
						--WHERE VCHOLDLICENSENO != ''  AND INTYEAR = @KMS-1 AND INTLEVEL = 2 AND INTAPPROVESTATUS = 4
						--AND INTDELETEDFLAG = 0
						--AND INTYEAR != @KMS
						--AND VCHLICENSENO is not null 
						--AND SUBSTRING (VCHOLDLICENSENO,1,2)= D.int_DistrictID
				
						--) 
						--[NO_OF_FPS_YET_TO_APPLY_FOR_RENEWAL]

						FROM PDS_DistrictMaster D WITH (NOLOCK)
						JOIN PDS_BlockMaster B WITH (NOLOCK)
						ON D.int_DistrictID = B.int_DistrictID
						where D.int_DistrictID = @DISTID
						
						)R
				  END

				  END
		
    END;

